From 2d699d250c6378f9187c4cdd94f0f481ce53edc7 Mon Sep 17 00:00:00 2001
From: Jon TURNEY <jon.turney@dronecode.org.uk>
Date: Fri, 4 Jul 2014 01:24:21 +0100
Subject: [PATCH 6/8] Fixes for building with --enable-egl --enable-gallium-egl
 without DRM

Based on a patch by Yaakov Selkowitz

Signed-off-by: Jon TURNEY <jon.turney@dronecode.org.uk>
---
 configure.ac                                    | 8 +++++---
 src/gallium/state_trackers/egl/x11/x11_screen.c | 4 ++++
 src/gallium/state_trackers/egl/x11/x11_screen.h | 2 ++
 3 files changed, 11 insertions(+), 3 deletions(-)

diff --git a/configure.ac b/configure.ac
index b60c4d6..94faf4f 100644
--- a/configure.ac
+++ b/configure.ac
@@ -1244,7 +1244,7 @@ if test "x$enable_egl" = xyes; then
     AC_CHECK_FUNC(mincore, [DEFINES="$DEFINES -DHAVE_MINCORE"])
 
     if test "$enable_static" != yes; then
-        if test "x$enable_dri" = xyes; then
+        if test "x$enable_dri" = xyes && test "x$dri_platform" = xdrm; then
 	    HAVE_EGL_DRIVER_DRI2=1
 	fi
 
@@ -1263,7 +1263,7 @@ if test "x$enable_gallium_egl" = xyes; then
     if test "x$enable_egl" = xno; then
         AC_MSG_ERROR([cannot enable egl_gallium without EGL])
     fi
-    if test "x$have_libdrm" != xyes; then
+    if test "x$driglx_direct" = xyes && test "x$have_libdrm" != xyes; then
         AC_MSG_ERROR([egl_gallium requires libdrm >= $LIBDRM_REQUIRED])
     fi
 
@@ -1496,7 +1496,9 @@ for plat in $egl_platforms; do
 		;;
 
 	x11)
-		PKG_CHECK_MODULES([XCB_DRI2], [x11-xcb xcb-dri2 >= $XCBDRI2_REQUIRED xcb-xfixes])
+		PKG_CHECK_MODULES([XCB_DRI2], [x11-xcb xcb-xfixes])
+# xcb-dri2 >= $XCBDRI2_REQUIRED should only be needed if HAVE_EGL_DRIVER_DRI2, but so should XCB_DRI2...
+# why HAVE_EGL_DRIVER_DRI2 is on if not static is weird...
 		;;
 
 	drm)
diff --git a/src/gallium/state_trackers/egl/x11/x11_screen.c b/src/gallium/state_trackers/egl/x11/x11_screen.c
index f7c5142..d37d463 100644
--- a/src/gallium/state_trackers/egl/x11/x11_screen.c
+++ b/src/gallium/state_trackers/egl/x11/x11_screen.c
@@ -26,7 +26,9 @@
 #include <fcntl.h>
 #include <sys/types.h>
 #include <sys/stat.h>
+#ifdef GLX_DIRECT_RENDERING
 #include <xf86drm.h>
+#endif
 #include <X11/Xlibint.h>
 #include <X11/extensions/XShm.h>
 
@@ -34,7 +36,9 @@
 #include "egllog.h"
 
 #include "x11_screen.h"
+#ifdef GLX_DIRECT_RENDERING
 #include "dri2.h"
+#endif
 #include "glxinit.h"
 
 struct x11_screen {
diff --git a/src/gallium/state_trackers/egl/x11/x11_screen.h b/src/gallium/state_trackers/egl/x11/x11_screen.h
index 0ef724d..91d77f9 100644
--- a/src/gallium/state_trackers/egl/x11/x11_screen.h
+++ b/src/gallium/state_trackers/egl/x11/x11_screen.h
@@ -27,7 +27,9 @@
 
 #include <X11/Xlib.h>
 #include <X11/Xutil.h>
+#ifdef GLX_DIRECT_RENDERING
 #include <X11/extensions/dri2tokens.h>
+#endif
 #include "GL/gl.h" /* for GL types needed by __GLcontextModes */
 #include "glcore.h"  /* for __GLcontextModes */
 #include "pipe/p_compiler.h"
-- 
1.8.5.5

