From 427083a1aec05b4ba445298669095437eb1ca67c Mon Sep 17 00:00:00 2001
From: Jon TURNEY <jon.turney@dronecode.org.uk>
Date: Mon, 3 Mar 2014 20:05:03 +0000
Subject: [PATCH 3/8] megadriver: explicitly link against glapi, link with
 -no-undefined

On cygwin we need to link against the static or shared glapi provider so it can
be built with no unresolved references.

"Use -no-undefined to assure libtool that the library has no unresolved symbols
at link time, so that libtool will build a shared library on platforms that
require that all symbols are resolved when the library is linked."

Signed-off-by: Jon TURNEY <jon.turney@dronecode.org.uk>
---
 src/mesa/drivers/dri/Makefile.am | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/src/mesa/drivers/dri/Makefile.am b/src/mesa/drivers/dri/Makefile.am
index e807612..f491937 100644
--- a/src/mesa/drivers/dri/Makefile.am
+++ b/src/mesa/drivers/dri/Makefile.am
@@ -51,7 +51,7 @@ driinclude_HEADERS = $(top_srcdir)/include/GL/internal/dri_interface.h
 nodist_EXTRA_mesa_dri_drivers_la_SOURCES = dummy.cpp
 mesa_dri_drivers_la_SOURCES =
 mesa_dri_drivers_la_LDFLAGS = \
-        -module -avoid-version -shared -shrext .so \
+        -module -avoid-version -shared -shrext .so -no-undefined \
         -Wl,-Bsymbolic \
         $(GC_SECTIONS) \
         $()
@@ -63,6 +63,12 @@ mesa_dri_drivers_la_LIBADD = \
         $(DRI_LIB_DEPS) \
         $()
 
+if HAVE_SHARED_GLAPI
+mesa_dri_drivers_la_LIBADD += $(top_builddir)/src/mapi/shared-glapi/libglapi.la
+else
+mesa_dri_drivers_la_LIBADD += $(top_builddir)/src/mapi/glapi/libglapi.la
+endif
+
 if NEED_MEGADRIVER
 dri_LTLIBRARIES = mesa_dri_drivers.la
 
-- 
1.8.5.5

